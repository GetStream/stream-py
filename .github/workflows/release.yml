name: Integration (pre-release / release)
on:
  release:
    types: [published] # Run after a Github publish

permissions:
  contents: read
  id-token: write       # REQUIRED for PyPI Trusted Publishing (OIDC)

jobs:
  integration:
    uses: ./.github/workflows/run_tests.yml
    with:
      marker: 'integration'
    secrets: inherit

  build:
    name: Build & Publish SDK
    runs-on: ubuntu-latest
    environment: pypi
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - uses: ./.github/actions/python-uv-setup

      - name: Clean dist directory
        run: |
          rm -rf dist

      - name: Build distributions
        run: |
          uv build

      - name: Extract package version
        id: get_version
        run: |
          VERSION=$(uvx -q hatch version)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Publish to PyPI (Trusted Publishing)
        run: uv publish

  test-index:
    name: Verify PIP install works
    needs: build
    runs-on: ubuntu-latest
    env:
      UV_NO_SOURCES: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - uses: ./.github/actions/python-uv-setup
        with:
          sync-flags: "--all-extras --dev"
      - name: Install from PyPI using uv
        run: |
          uv pip install getstream==${{ needs.build.outputs.version }}
